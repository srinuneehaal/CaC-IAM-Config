name: Config Plan & Apply Workflow

on:
  push:
    branches:
      - main
    paths:
      - 'configs/**'
  workflow_dispatch:

permissions:
  contents: read
  actions: write
  pages: write
  id-token: write

env:
  CHANGED_FILES_DIR: configs
  PLAN_DIR: plan
  MASTER_PLAN_FILE: masterplan.json
  MASTER_PLAN_REPORT_ENABLED: true
  CAC_IAM_REPO: srinuneehaal/CaC-IAM
  CAC_IAM_WORKFLOW: build.yml
  CAC_IAM_BRANCH: main
  CAC_IAM_ARTIFACT_NAME: java-artifacts

jobs:
  plan:
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.export.outputs.has_changes }}
      changed_files: ${{ steps.export.outputs.changed_files }}
      has_items: ${{ steps.plan_meta.outputs.has_items }}
      report_found: ${{ steps.report.outputs.found }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect config changes
        id: changed
        uses: tj-actions/changed-files@v45
        with:
          since_last_remote_commit: true
          include_deleted_files: true
          include_renamed_files: true
          files: |
            configs/**

      - name: Export changed file list
        id: export
        run: |
          set -euo pipefail
          # Include added/modified plus deleted/renamed entries so CHANGED_FILES covers all statuses.
          files="${{ steps.changed.outputs.all_changed_files }} ${{ steps.changed.outputs.deleted_files }} ${{ steps.changed.outputs.renamed_files }}"
          echo "Detected config file changes:"
          printf '%s\n' "$files"
          spaced=$(printf '%s\n' $files | awk 'NF' | sort -u | tr '\n' ' ' | xargs)
          has_changes=false
          if [ -n "$spaced" ]; then
            has_changes=true
            echo "CHANGED_FILES=$spaced" >> "$GITHUB_ENV"
          fi
          echo "changed_files=$spaced" >> "$GITHUB_OUTPUT"
          echo "has_changes=$has_changes" >> "$GITHUB_OUTPUT"

      - name: Note no config changes
        if: steps.export.outputs.has_changes != 'true'
        run: echo "No config changes detected; skipping plan/apply."

      - name: Download CaC-IAM CLI artifact
        if: steps.export.outputs.has_changes == 'true'
        uses: dawidd6/action-download-artifact@v3
        with:
          github_token: ${{ secrets.CAC_IAM_ARTIFACT_TOKEN || secrets.GITHUB_TOKEN }}
          repo: ${{ env.CAC_IAM_REPO }}
          workflow: ${{ env.CAC_IAM_WORKFLOW }}
          branch: ${{ env.CAC_IAM_BRANCH }}
          workflow_conclusion: success
          name: ${{ env.CAC_IAM_ARTIFACT_NAME }}
          path: cac-iam-build

      - name: Locate CaC-IAM jar
        if: steps.export.outputs.has_changes == 'true'
        id: jar
        run: |
          set -euo pipefail
          jar=$(find "cac-iam-build" -type f -name "cac-iam-*.jar" ! -name "original-*.jar" | head -n 1)
          if [ -z "$jar" ]; then
            jar=$(find "cac-iam-build" -type f -name "*.jar" | head -n 1)
          fi
          if [ -z "$jar" ]; then
            echo "No jar found in downloaded artifact" >&2
            ls -R cac-iam-build || true
            exit 1
          fi
          echo "path=$jar" >> "$GITHUB_OUTPUT"

      - name: Set up JDK 21
        if: steps.export.outputs.has_changes == 'true'
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Generate master plan
        if: steps.export.outputs.has_changes == 'true'
        run: |
          set -euo pipefail
          java -jar "${{ steps.jar.outputs.path }}" --plan
        env:
          AZURE_COSMOS_KEY: ${{ secrets.AZURE_COSMOS_KEY }}
          AZURE_COSMOS_URI: ${{ secrets.AZURE_COSMOS_URI }}
          AZURE_COSMOS_DATABASE: ${{ secrets.AZURE_COSMOS_DATABASE }}
          AZURE_COSMOS_CONTAINER: ${{ secrets.AZURE_COSMOS_CONTAINER }}
          CHANGED_FILES: ${{ steps.export.outputs.changed_files }}
          CHANGED_FILES_DIR: ${{ env.CHANGED_FILES_DIR }}
          MASTER_PLAN_FILE: ${{ env.MASTER_PLAN_FILE }}
          MASTER_PLAN_REPORT_ENABLED: ${{ env.MASTER_PLAN_REPORT_ENABLED }}
          PLAN_DIR: ${{ env.PLAN_DIR }}

      - name: Check plan items
        id: plan_meta
        if: steps.export.outputs.has_changes == 'true'
        run: |
          set -euo pipefail
          plan_file="${{ env.PLAN_DIR }}/${{ env.MASTER_PLAN_FILE }}"
          items=$(jq '.items | length' "$plan_file")
          echo "items=$items" >> "$GITHUB_OUTPUT"
          if [ "$items" -gt 0 ]; then
            echo "has_items=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_items=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Locate master plan report
        id: report
        if: steps.plan_meta.outputs.has_items == 'true'
        run: |
          set -euo pipefail
          path="${{ env.PLAN_DIR }}/masterplan.html"
          if [ -f "$path" ]; then
            echo "found=true" >> "$GITHUB_OUTPUT"
            echo "path=$path" >> "$GITHUB_OUTPUT"
          else
            echo "found=false" >> "$GITHUB_OUTPUT"
            echo "Master plan report not found at $path"
          fi

      - name: Upload master plan report
        id: upload_report
        if: steps.report.outputs.found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: masterplan-report
          path: ${{ steps.report.outputs.path }}

      - name: Publish report link
        if: steps.upload_report.outputs.artifact-url != ''
        run: |
          echo "Master plan report: [download](${{ steps.upload_report.outputs.artifact-url }})" >> "$GITHUB_STEP_SUMMARY"

      - name: Upload master plan artifact
        if: steps.export.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: masterplan
          path: ${{ format('{0}/{1}', env.PLAN_DIR, env.MASTER_PLAN_FILE) }}

  approval:
    needs: plan
    if: needs.plan.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    environment:
      name: apply-approval
    steps:
      - name: Await approval to apply
        run: echo "Plan generated; awaiting approval to proceed to apply."

  publish-report:
    needs: plan
    if: needs.plan.outputs.has_items == 'true' && needs.plan.outputs.report_found == 'true'
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}
    steps:
      - name: Download master plan report artifact
        uses: actions/download-artifact@v4
        with:
          name: masterplan-report
          path: report
          if-no-artifact-found: ignore

      - name: Add index page
        run: |
          set -euo pipefail
          if [ -f "report/masterplan.html" ]; then
            cp report/masterplan.html report/index.html
            echo "Created index.html for GitHub Pages"
          else
            echo "masterplan.html not found in report/; nothing to publish" >&2
            exit 1
          fi

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: report

      - name: Deploy to GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4

  apply:
    needs:
      - plan
      - approval
    if: needs.plan.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Download CaC-IAM CLI artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          github_token: ${{ secrets.CAC_IAM_ARTIFACT_TOKEN || secrets.GITHUB_TOKEN }}
          repo: ${{ env.CAC_IAM_REPO }}
          workflow: ${{ env.CAC_IAM_WORKFLOW }}
          branch: ${{ env.CAC_IAM_BRANCH }}
          workflow_conclusion: success
          name: ${{ env.CAC_IAM_ARTIFACT_NAME }}
          path: cac-iam-build

      - name: Locate CaC-IAM jar
        id: jar
        run: |
          set -euo pipefail
          jar=$(find "cac-iam-build" -type f -name "cac-iam-*.jar" ! -name "original-*.jar" | head -n 1)
          if [ -z "$jar" ]; then
            jar=$(find "cac-iam-build" -type f -name "*.jar" | head -n 1)
          fi
          if [ -z "$jar" ]; then
            echo "No jar found in downloaded artifact" >&2
            ls -R cac-iam-build || true
            exit 1
          fi
          echo "path=$jar" >> "$GITHUB_OUTPUT"

      - name: Download master plan artifact
        uses: actions/download-artifact@v4
        with:
          name: masterplan
          path: ${{ env.PLAN_DIR }}

      - name: Apply master plan
        run: |
          set -euo pipefail
          java -jar "${{ steps.jar.outputs.path }}" --apply
        env:
          AZURE_COSMOS_KEY: ${{ secrets.AZURE_COSMOS_KEY }}
          AZURE_COSMOS_URI: ${{ secrets.AZURE_COSMOS_URI }}
          AZURE_COSMOS_DATABASE: ${{ secrets.AZURE_COSMOS_DATABASE }}
          AZURE_COSMOS_CONTAINER: ${{ secrets.AZURE_COSMOS_CONTAINER }}
          CHANGED_FILES: ${{ needs.plan.outputs.changed_files }}
          CHANGED_FILES_DIR: ${{ env.CHANGED_FILES_DIR }}
          MASTER_PLAN_FILE: ${{ env.MASTER_PLAN_FILE }}
          MASTER_PLAN_REPORT_ENABLED: ${{ env.MASTER_PLAN_REPORT_ENABLED }}
          PLAN_DIR: ${{ env.PLAN_DIR }}
